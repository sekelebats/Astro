---
import { getCollection } from 'astro:content';
import BlogLayout from '../../layouts/BlogLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });
  
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const allPosts = await getCollection('blog', ({ data }) => data.draft !== true);
const relatedPosts = allPosts
  .filter(post => post.data.category === entry.data.category && post.slug !== entry.slug)
  .slice(0, 3);

const currentUrl = `${Astro.site}blog/${entry.slug}`;
const formattedDate = entry.data.date.toLocaleDateString('id-ID', { 
  year: 'numeric', 
  month: 'long', 
  day: 'numeric' 
});
---

<BlogLayout 
  title={entry.data.title}
  description={entry.data.description}
  author={entry.data.author}
  date={entry.data.date.toISOString()}
  category={entry.data.category}
  image={entry.data.image}
  canonical={currentUrl}
>
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": entry.data.title,
    "description": entry.data.description,
    "image": entry.data.image,
    "datePublished": entry.data.date.toISOString(),
    "dateModified": entry.data.date.toISOString(),
    "author": {
      "@type": "Person",
      "name": entry.data.author
    },
    "publisher": {
      "@type": "Organization",
      "name": "ModernBlog",
      "logo": {
        "@type": "ImageObject",
        "url": `${Astro.site}logo.png`
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": currentUrl
    }
  })} />

  <Header />
  
  <main class="article-page">
    <div class="container">
      <article class="article">
        <div class="article-header">
          <button onclick="history.back()" class="back-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Kembali ke Beranda
          </button>
        </div>

        <div class="article-content">
          <img src={entry.data.image} alt={entry.data.title} class="article-image" />
          
          <div class="article-body">
            <div class="article-meta">
              <span class="meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                {formattedDate}
              </span>
              <span class="meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                {entry.data.author}
              </span>
              <span class="article-category">{entry.data.category}</span>
            </div>

            <h1 class="article-title">{entry.data.title}</h1>

            <div class="social-share">
              <span class="share-label">Share:</span>
              <a href={`https://twitter.com/intent/tweet?url=${currentUrl}&text=${entry.data.title}`} target="_blank" class="share-btn" aria-label="Share on Twitter">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"></path>
                </svg>
              </a>
              <a href={`https://www.facebook.com/sharer/sharer.php?u=${currentUrl}`} target="_blank" class="share-btn" aria-label="Share on Facebook">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                  <path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"></path>
                  <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                </svg>
              </a>
              <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${currentUrl}`} target="_blank" class="share-btn" aria-label="Share on LinkedIn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"></path>
                  <rect x="2" y="9" width="4" height="12"></rect>
                  <circle cx="4" cy="4" r="2"></circle>
                </svg>
              </a>
              <button id="copyLink" class="share-btn" aria-label="Copy link">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"></path>
                  <polyline points="16 6 12 2 8 6"></polyline>
                  <line x1="12" y1="2" x2="12" y2="15"></line>
                </svg>
              </button>
            </div>

            <div class="article-text prose">
              <Content />
            </div>

            {relatedPosts.length > 0 && (
              <div class="related-posts">
                <h3 class="related-title">Artikel Terkait</h3>
                <div class="related-grid">
                  {relatedPosts.map(post => (
                    <a href={`/blog/${post.slug}`} class="related-post">
                      <img src={post.data.image} alt={post.data.title} />
                      <h4>{post.data.title}</h4>
                      <p>{post.data.date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </a>
                  ))}
                </div>
              </div>
            )}

            <div class="newsletter">
              <h3 class="newsletter-title">Berlangganan Newsletter</h3>
              <p class="newsletter-desc">Dapatkan artikel terbaru langsung ke inbox Anda</p>
              <form class="newsletter-form" id="subscribeForm">
                <input 
                  type="email" 
                  placeholder="Email Anda" 
                  required 
                  class="newsletter-input"
                  id="emailInput"
                />
                <button type="submit" class="newsletter-btn">Subscribe</button>
              </form>
            </div>
          </div>
        </div>
      </article>
    </div>
  </main>

  <Footer />
</BlogLayout>

<style>
  .article-page {
    max-width: 1024px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }
  
  .article-header {
    margin-bottom: 1rem;
  }
  
  .back-button {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: none;
    border: none;
    color: black;
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 500;
    cursor: pointer;
    padding: 0.5rem 0;
  }
  
  .back-button:hover {
    text-decoration: underline;
  }
  
  .article {
    background: white;
    border: 2px solid black;
  }
  
  .article-image {
    width: 100%;
    height: 24rem;
    object-fit: cover;
    border-bottom: 2px solid black;
  }
  
  .article-body {
    padding: 1.5rem;
  }
  
  @media (min-width: 768px) {
    .article-body {
      padding: 3rem;
    }
  }
  
  .article-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .article-category {
    padding: 0.25rem 0.75rem;
    background: black;
    color: white;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .article-title {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 1.5rem;
  }
  
  @media (min-width: 768px) {
    .article-title {
      font-size: 2.5rem;
    }
  }
  
  .social-share {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 1.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid black;
  }
  
  .share-label {
    font-size: 0.875rem;
    font-weight: 600;
  }
  
  .share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    border: 1px solid black;
    background: white;
    color: black;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
  }
  
  .share-btn:hover {
    background: black;
    color: white;
  }
  
  .article-text {
    font-size: 1rem;
    line-height: 1.8;
    margin-bottom: 3rem;
  }
  
  /* Markdown Prose Styling */
  .prose :global(h2) {
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  
  .prose :global(h3) {
    font-size: 1.25rem;
    font-weight: 700;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }
  
  .prose :global(p) {
    margin-bottom: 1rem;
  }
  
  .prose :global(ul), .prose :global(ol) {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .prose :global(li) {
    margin-bottom: 0.5rem;
  }
  
  .prose :global(strong) {
    font-weight: 700;
  }
  
  .prose :global(a) {
    color: black;
    text-decoration: underline;
  }
  
  .related-posts {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid black;
  }
  
  .related-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }
  
  .related-grid {
    display: grid;
    gap: 1.5rem;
  }
  
  @media (min-width: 768px) {
    .related-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  .related-post {
    text-decoration: none;
    color: black;
  }
  
  .related-post img {
    width: 100%;
    height: 10rem;
    object-fit: cover;
    border: 2px solid black;
    margin-bottom: 0.75rem;
  }
  
  .related-post h4 {
    font-size: 0.875rem;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: 0.25rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .related-post:hover h4 {
    text-decoration: underline;
  }
  
  .related-post p {
    font-size: 0.75rem;
  }
  
  .newsletter {
    margin-top: 2rem;
    padding: 1.5rem;
    border: 2px solid black;
  }
  
  .newsletter-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  
  .newsletter-desc {
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }
  
  .newsletter-form {
    display: flex;
    gap: 0.5rem;
  }
  
  .newsletter-input {
    flex: 1;
    padding: 0.5rem 1rem;
    border: 2px solid black;
    font-family: 'IBM Plex Mono', monospace;
  }
  
  .newsletter-input:focus {
    outline: none;
  }
  
  .newsletter-btn {
    padding: 0.5rem 1.5rem;
    background: black;
    color: white;
    border: 2px solid black;
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .newsletter-btn:hover {
    background: white;
    color: black;
  }
</style>

<script>
  const copyBtn = document.getElementById('copyLink');
  const subscribeForm = document.getElementById('subscribeForm');
  const emailInput = document.getElementById('emailInput');
  
  copyBtn?.addEventListener('click', () => {
    navigator.clipboard.writeText(window.location.href);
    alert('Link berhasil disalin!');
  });
  
  subscribeForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = (emailInput as HTMLInputElement)?.value;
    alert(`Terima kasih! Email ${email} telah berhasil berlangganan.`);
    (emailInput as HTMLInputElement).value = '';
  });
</script>
    
